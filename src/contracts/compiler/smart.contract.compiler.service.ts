import { BadRequestException, Injectable, Logger } from "@nestjs/common";
import { CreateSmartContractNep11Dto } from "../dto/create.smart.contract.nep11.dto";
import { CreateSmartContractNep17Dto } from "../dto/create.smart.contract.nep17.dto";
import { CaasClient } from "./caas.client";
import { CaasTask } from "./types/caas.task";
import { CaasResult } from "./types/caas.task.result";

@Injectable()
export class SmartContractCompilerService {
    private readonly logger = new Logger(SmartContractCompilerService.name);

    private static readonly nep17Template = 'dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uTnVtZXJpY3M7CnVzaW5nIFN5c3RlbS5Db21wb25lbnRNb2RlbDsKdXNpbmcgU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlczsKdXNpbmcgTmVvLlNtYXJ0Q29udHJhY3QuRnJhbWV3b3JrOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuTmF0aXZlOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuU2VydmljZXM7CgpuYW1lc3BhY2UgTmVvLlNtYXJ0Q29udHJhY3QuRXhhbXBsZXMKewogICAgcHVibGljIGFic3RyYWN0IGNsYXNzIE5YQVRva2VuQ29udHJhY3QgOiBTbWFydENvbnRyYWN0LkZyYW1ld29yay5TbWFydENvbnRyYWN0CiAgICB7CiAgICAgICAgcHJvdGVjdGVkIGNvbnN0IGJ5dGUgUHJlZml4X1RvdGFsU3VwcGx5ID0gMHgwMDsKICAgICAgICBwcm90ZWN0ZWQgY29uc3QgYnl0ZSBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CgogICAgICAgIFtTYWZlXQogICAgICAgIFtEaXNwbGF5TmFtZSgiTmFtZSIpXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgVG9rZW5OYW1lKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgU3ltYm9sKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBieXRlIERlY2ltYWxzKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBUb3RhbFN1cHBseSgpID0+IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KFN0b3JhZ2UuQ3VycmVudENvbnRleHQsIG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfSk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBCYWxhbmNlT2YoVUludDE2MCBvd25lcikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvd25lciBpcyBudWxsIHx8ICFvd25lci5Jc1ZhbGlkKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiQmFsYW5jZU9mOiBUaGUgYXJndW1lbnQgJ293bmVyJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBTdG9yYWdlTWFwIGJhbGFuY2VNYXAgPSBuZXcoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0JhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gKEJpZ0ludGVnZXIpYmFsYW5jZU1hcFtvd25lcl07CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIHZvaWQgVXBkYXRlVG90YWxTdXBwbHkoQmlnSW50ZWdlciBpbmNyZW1lbnQpCiAgICAgICAgewogICAgICAgICAgICBTdG9yYWdlQ29udGV4dCBjb250ZXh0ID0gU3RvcmFnZS5DdXJyZW50Q29udGV4dDsKICAgICAgICAgICAgYnl0ZVtdIGtleSA9IG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfTsKICAgICAgICAgICAgQmlnSW50ZWdlciB0b3RhbFN1cHBseSA9IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KGNvbnRleHQsIGtleSk7CiAgICAgICAgICAgIHRvdGFsU3VwcGx5ICs9IGluY3JlbWVudDsKICAgICAgICAgICAgU3RvcmFnZS5QdXQoY29udGV4dCwga2V5LCB0b3RhbFN1cHBseSk7CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIGJvb2wgVXBkYXRlQmFsYW5jZShVSW50MTYwIG93bmVyLCBCaWdJbnRlZ2VyIGluY3JlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIFN0b3JhZ2VNYXAgYmFsYW5jZU1hcCA9IG5ldyhTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQmFsYW5jZSk7CiAgICAgICAgICAgIEJpZ0ludGVnZXIgYmFsYW5jZSA9IChCaWdJbnRlZ2VyKWJhbGFuY2VNYXBbb3duZXJdOwogICAgICAgICAgICBiYWxhbmNlICs9IGluY3JlbWVudDsKICAgICAgICAgICAgaWYgKGJhbGFuY2UgPCAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChiYWxhbmNlLklzWmVybykKICAgICAgICAgICAgICAgIGJhbGFuY2VNYXAuRGVsZXRlKG93bmVyKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgYmFsYW5jZU1hcC5QdXQob3duZXIsIGJhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgYWJzdHJhY3QgY2xhc3MgTlhBTmVwMTdUb2tlbiA6IE5YQVRva2VuQ29udHJhY3QKICAgIHsKICAgICAgICBwdWJsaWMgZGVsZWdhdGUgdm9pZCBPblRyYW5zZmVyRGVsZWdhdGUoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCk7CgogICAgICAgIFtEaXNwbGF5TmFtZSgiVHJhbnNmZXIiKV0KICAgICAgICBwdWJsaWMgc3RhdGljIGV2ZW50IE9uVHJhbnNmZXJEZWxlZ2F0ZSBPblRyYW5zZmVyOwoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgVHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZnJvbSBpcyBudWxsIHx8ICFmcm9tLklzVmFsaWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUcmFuc2ZlcjogVGhlIGFyZ3VtZW50ICdmcm9tJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAodG8gaXMgbnVsbCB8fCAhdG8uSXNWYWxpZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYXJndW1lbnQgJ3RvJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAoYW1vdW50IDwgMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYW1vdW50IG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXIuIik7CiAgICAgICAgICAgIGlmICghUnVudGltZS5DaGVja1dpdG5lc3MoZnJvbSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKGFtb3VudCAhPSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIVVwZGF0ZUJhbGFuY2UoZnJvbSwgLWFtb3VudCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgVXBkYXRlQmFsYW5jZSh0bywgK2Ftb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUG9zdFRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQsIGRhdGEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBNaW50SW1wbChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFtb3VudC5TaWduIDwgMCkgdGhyb3cgbmV3IEFyZ3VtZW50T3V0T2ZSYW5nZUV4Y2VwdGlvbihuYW1lb2YoYW1vdW50KSk7CiAgICAgICAgICAgIGlmIChhbW91bnQuSXNaZXJvKSByZXR1cm47CiAgICAgICAgICAgIFVwZGF0ZUJhbGFuY2UoYWNjb3VudCwgK2Ftb3VudCk7CiAgICAgICAgICAgIFVwZGF0ZVRvdGFsU3VwcGx5KCthbW91bnQpOwogICAgICAgICAgICBQb3N0VHJhbnNmZXIobnVsbCwgYWNjb3VudCwgYW1vdW50LCBudWxsKTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBCdXJuSW1wbChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFtb3VudC5TaWduIDwgMCkgdGhyb3cgbmV3IEFyZ3VtZW50T3V0T2ZSYW5nZUV4Y2VwdGlvbihuYW1lb2YoYW1vdW50KSk7CiAgICAgICAgICAgIGlmIChhbW91bnQuSXNaZXJvKSByZXR1cm47CiAgICAgICAgICAgIGlmICghVXBkYXRlQmFsYW5jZShhY2NvdW50LCAtYW1vdW50KSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIFVwZGF0ZVRvdGFsU3VwcGx5KC1hbW91bnQpOwogICAgICAgICAgICBQb3N0VHJhbnNmZXIoYWNjb3VudCwgbnVsbCwgYW1vdW50LCBudWxsKTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBQb3N0VHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBPblRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpOwogICAgICAgICAgICBpZiAodG8gaXMgbm90IG51bGwgJiYgQ29udHJhY3RNYW5hZ2VtZW50LkdldENvbnRyYWN0KHRvKSBpcyBub3QgbnVsbCkKICAgICAgICAgICAgICAgIENvbnRyYWN0LkNhbGwodG8sICJvbk5FUDE3UGF5bWVudCIsIENhbGxGbGFncy5BbGwsIGZyb20sIGFtb3VudCwgZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIFtNYW5pZmVzdEV4dHJhKCJBdXRob3IiLCAie3tDb250cmFjdEF1dGhvck5hbWV9fSIpXQogICAgW01hbmlmZXN0RXh0cmEoIkVtYWlsIiwgInt7Q29udHJhY3RBdXRob3JFbWFpbH19IildCiAgICBbTWFuaWZlc3RFeHRyYSgiRGVzY3JpcHRpb24iLCAie3tDb250cmFjdERlc2NyaXB0aW9ufX0iKV0KICAgIFtNYW5pZmVzdEV4dHJhKCJWZXJzaW9uIiwgIjEuMCIpXQogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgcGFydGlhbCBjbGFzcyB7e0NvbnRyYWN0TmFtZX19VG9rZW4gOiBOWEFOZXAxN1Rva2VuCiAgICB7CiAgICAgICAgW0luaXRpYWxWYWx1ZSgie3tDb250cmFjdEF1dGhvckFkZHJlc3N9fSIsIENvbnRyYWN0UGFyYW1ldGVyVHlwZS5IYXNoMTYwKV0KICAgICAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBVSW50MTYwIG93bmVyID0gZGVmYXVsdDsKICAgICAgICBbSW5pdGlhbFZhbHVlKCJ7e1N5c3RlbU93bmVyQWRkcmVzc319IiwgQ29udHJhY3RQYXJhbWV0ZXJUeXBlLkhhc2gxNjApXQogICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFVJbnQxNjAgZGVwbG95ZXIgPSBkZWZhdWx0OwoKICAgICAgICAvLyBQcmVmaXhfVG90YWxTdXBwbHkgPSAweDAwOyBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CiAgICAgICAgcHJpdmF0ZSBjb25zdCBieXRlIFByZWZpeF9Db250cmFjdCA9IDB4MDI7CiAgICAgICAgcHVibGljIHN0YXRpYyByZWFkb25seSBTdG9yYWdlTWFwIENvbnRyYWN0TWFwID0gbmV3IFN0b3JhZ2VNYXAoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0NvbnRyYWN0KTsKICAgICAgICBwcml2YXRlIHN0YXRpYyBpbnQgSW5pdGlhbENvaW5zID0+IHt7Q29udHJhY3RJbml0aWFsQ29pbnN9fTsKCiAgICAgICAgW0Rpc3BsYXlOYW1lKCJOYW1lIildCiAgICAgICAgcHVibGljIG92ZXJyaWRlIHN0cmluZyBUb2tlbk5hbWUoKSA9PiAie3tDb250cmFjdE5hbWV9fSI7CiAgICAgICAgcHVibGljIG92ZXJyaWRlIHN0cmluZyBTeW1ib2woKSA9PiAie3tDb250cmFjdFN5bWJvbH19IjsKICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgYnl0ZSBEZWNpbWFscygpID0+IHt7Q29udHJhY3REZWNpbWFsc319OwoKICAgICAgICBwdWJsaWMgc3RhdGljIHZvaWQgX2RlcGxveShvYmplY3QgZGF0YSwgYm9vbCB1cGRhdGUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodXBkYXRlKSByZXR1cm47CiAgICAgICAgICAgIE1pbnQob3duZXIsIEluaXRpYWxDb2lucyk7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIG5ldyB2b2lkIE1pbnQoVUludDE2MCBhY2NvdW50LCBCaWdJbnRlZ2VyIGFtb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghSXNPd25lcigpKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigkIk1pbnQ6IE5vIEF1dGhvcml6YXRpb24iKTsKICAgICAgICAgICAgTWludEltcGwoYWNjb3VudCwgYW1vdW50KTsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgbmV3IHZvaWQgQnVybihVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiQnVybjogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBCdXJuSW1wbChhY2NvdW50LCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIHN0YXRpYyBib29sIFVwZGF0ZShCeXRlU3RyaW5nIG5lZkZpbGUsIHN0cmluZyBtYW5pZmVzdCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghSXNPd25lcigpKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigkIlVwZGF0ZTogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBDb250cmFjdE1hbmFnZW1lbnQuVXBkYXRlKG5lZkZpbGUsIG1hbmlmZXN0LCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgRGVzdHJveSgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUlzT3duZXIoKSkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oJCJEZXN0cm95OiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIENvbnRyYWN0TWFuYWdlbWVudC5EZXN0cm95KCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgYm9vbCBJc093bmVyKCkgewogICAgICAgICAgICByZXR1cm4gUnVudGltZS5DaGVja1dpdG5lc3Mob3duZXIpIHx8IFJ1bnRpbWUuQ2hlY2tXaXRuZXNzKGRlcGxveWVyKTsKICAgICAgICB9CiAgICB9Cn0K';
    private static readonly nep11Template = 'dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uTnVtZXJpY3M7CnVzaW5nIFN5c3RlbS5Db21wb25lbnRNb2RlbDsKdXNpbmcgU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlczsKdXNpbmcgTmVvLlNtYXJ0Q29udHJhY3QuRnJhbWV3b3JrOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuTmF0aXZlOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuU2VydmljZXM7CgpuYW1lc3BhY2UgTmVvLlNtYXJ0Q29udHJhY3QuRXhhbXBsZXMKewogICAgcHVibGljIGFic3RyYWN0IGNsYXNzIE5YQVRva2VuQ29udHJhY3QgOiBTbWFydENvbnRyYWN0LkZyYW1ld29yay5TbWFydENvbnRyYWN0CiAgICB7CiAgICAgICAgcHJvdGVjdGVkIGNvbnN0IGJ5dGUgUHJlZml4X1RvdGFsU3VwcGx5ID0gMHgwMDsKICAgICAgICBwcm90ZWN0ZWQgY29uc3QgYnl0ZSBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CgogICAgICAgIFtTYWZlXQogICAgICAgIFtEaXNwbGF5TmFtZSgiTmFtZSIpXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgVG9rZW5OYW1lKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgU3ltYm9sKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBieXRlIERlY2ltYWxzKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBUb3RhbFN1cHBseSgpID0+IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KFN0b3JhZ2UuQ3VycmVudENvbnRleHQsIG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfSk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBCYWxhbmNlT2YoVUludDE2MCBvd25lcikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvd25lciBpcyBudWxsIHx8ICFvd25lci5Jc1ZhbGlkKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiQmFsYW5jZU9mOiBUaGUgYXJndW1lbnQgJ293bmVyJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBTdG9yYWdlTWFwIGJhbGFuY2VNYXAgPSBuZXcoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0JhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gKEJpZ0ludGVnZXIpYmFsYW5jZU1hcFtvd25lcl07CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIHZvaWQgVXBkYXRlVG90YWxTdXBwbHkoQmlnSW50ZWdlciBpbmNyZW1lbnQpCiAgICAgICAgewogICAgICAgICAgICBTdG9yYWdlQ29udGV4dCBjb250ZXh0ID0gU3RvcmFnZS5DdXJyZW50Q29udGV4dDsKICAgICAgICAgICAgYnl0ZVtdIGtleSA9IG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfTsKICAgICAgICAgICAgQmlnSW50ZWdlciB0b3RhbFN1cHBseSA9IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KGNvbnRleHQsIGtleSk7CiAgICAgICAgICAgIHRvdGFsU3VwcGx5ICs9IGluY3JlbWVudDsKICAgICAgICAgICAgU3RvcmFnZS5QdXQoY29udGV4dCwga2V5LCB0b3RhbFN1cHBseSk7CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIGJvb2wgVXBkYXRlQmFsYW5jZShVSW50MTYwIG93bmVyLCBCaWdJbnRlZ2VyIGluY3JlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIFN0b3JhZ2VNYXAgYmFsYW5jZU1hcCA9IG5ldyhTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQmFsYW5jZSk7CiAgICAgICAgICAgIEJpZ0ludGVnZXIgYmFsYW5jZSA9IChCaWdJbnRlZ2VyKWJhbGFuY2VNYXBbb3duZXJdOwogICAgICAgICAgICBiYWxhbmNlICs9IGluY3JlbWVudDsKICAgICAgICAgICAgaWYgKGJhbGFuY2UgPCAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChiYWxhbmNlLklzWmVybykKICAgICAgICAgICAgICAgIGJhbGFuY2VNYXAuRGVsZXRlKG93bmVyKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgYmFsYW5jZU1hcC5QdXQob3duZXIsIGJhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgYWJzdHJhY3QgY2xhc3MgTlhBTmVwMTdUb2tlbiA6IE5YQVRva2VuQ29udHJhY3QKICAgIHsKICAgICAgICBwdWJsaWMgZGVsZWdhdGUgdm9pZCBPblRyYW5zZmVyRGVsZWdhdGUoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCk7CgogICAgICAgIFtEaXNwbGF5TmFtZSgiVHJhbnNmZXIiKV0KICAgICAgICBwdWJsaWMgc3RhdGljIGV2ZW50IE9uVHJhbnNmZXJEZWxlZ2F0ZSBPblRyYW5zZmVyOwoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgVHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZnJvbSBpcyBudWxsIHx8ICFmcm9tLklzVmFsaWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUcmFuc2ZlcjogVGhlIGFyZ3VtZW50ICdmcm9tJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAodG8gaXMgbnVsbCB8fCAhdG8uSXNWYWxpZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYXJndW1lbnQgJ3RvJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAoYW1vdW50IDwgMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYW1vdW50IG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXIuIik7CiAgICAgICAgICAgIGlmICghUnVudGltZS5DaGVja1dpdG5lc3MoZnJvbSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKGFtb3VudCAhPSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIVVwZGF0ZUJhbGFuY2UoZnJvbSwgLWFtb3VudCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgVXBkYXRlQmFsYW5jZSh0bywgK2Ftb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgUG9zdFRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQsIGRhdGEpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBNaW50SW1wbChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFtb3VudC5TaWduIDwgMCkgdGhyb3cgbmV3IEFyZ3VtZW50T3V0T2ZSYW5nZUV4Y2VwdGlvbihuYW1lb2YoYW1vdW50KSk7CiAgICAgICAgICAgIGlmIChhbW91bnQuSXNaZXJvKSByZXR1cm47CiAgICAgICAgICAgIFVwZGF0ZUJhbGFuY2UoYWNjb3VudCwgK2Ftb3VudCk7CiAgICAgICAgICAgIFVwZGF0ZVRvdGFsU3VwcGx5KCthbW91bnQpOwogICAgICAgICAgICBQb3N0VHJhbnNmZXIobnVsbCwgYWNjb3VudCwgYW1vdW50LCBudWxsKTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBCdXJuSW1wbChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFtb3VudC5TaWduIDwgMCkgdGhyb3cgbmV3IEFyZ3VtZW50T3V0T2ZSYW5nZUV4Y2VwdGlvbihuYW1lb2YoYW1vdW50KSk7CiAgICAgICAgICAgIGlmIChhbW91bnQuSXNaZXJvKSByZXR1cm47CiAgICAgICAgICAgIGlmICghVXBkYXRlQmFsYW5jZShhY2NvdW50LCAtYW1vdW50KSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCk7CiAgICAgICAgICAgIFVwZGF0ZVRvdGFsU3VwcGx5KC1hbW91bnQpOwogICAgICAgICAgICBQb3N0VHJhbnNmZXIoYWNjb3VudCwgbnVsbCwgYW1vdW50LCBudWxsKTsKICAgICAgICB9CgogICAgICAgIHByb3RlY3RlZCBzdGF0aWMgdm9pZCBQb3N0VHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBPblRyYW5zZmVyKGZyb20sIHRvLCBhbW91bnQpOwogICAgICAgICAgICBpZiAodG8gaXMgbm90IG51bGwgJiYgQ29udHJhY3RNYW5hZ2VtZW50LkdldENvbnRyYWN0KHRvKSBpcyBub3QgbnVsbCkKICAgICAgICAgICAgICAgIENvbnRyYWN0LkNhbGwodG8sICJvbk5FUDE3UGF5bWVudCIsIENhbGxGbGFncy5BbGwsIGZyb20sIGFtb3VudCwgZGF0YSk7CiAgICAgICAgfQogICAgfQoKICAgIFtNYW5pZmVzdEV4dHJhKCJBdXRob3IiLCAie3tDb250cmFjdEF1dGhvck5hbWV9fSIpXQogICAgW01hbmlmZXN0RXh0cmEoIkVtYWlsIiwgInt7Q29udHJhY3RBdXRob3JFbWFpbH19IildCiAgICBbTWFuaWZlc3RFeHRyYSgiRGVzY3JpcHRpb24iLCAie3tDb250cmFjdERlc2NyaXB0aW9ufX0iKV0KICAgIFtNYW5pZmVzdEV4dHJhKCJWZXJzaW9uIiwgIjEuMCIpXQogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgcGFydGlhbCBjbGFzcyB7e0NvbnRyYWN0TmFtZX19VG9rZW4gOiBOWEFOZXAxN1Rva2VuCiAgICB7CiAgICAgICAgW0luaXRpYWxWYWx1ZSgie3tDb250cmFjdEF1dGhvckFkZHJlc3N9fSIsIENvbnRyYWN0UGFyYW1ldGVyVHlwZS5IYXNoMTYwKV0KICAgICAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBVSW50MTYwIG93bmVyID0gZGVmYXVsdDsKICAgICAgICBbSW5pdGlhbFZhbHVlKCJ7e1N5c3RlbU93bmVyQWRkcmVzc319IiwgQ29udHJhY3RQYXJhbWV0ZXJUeXBlLkhhc2gxNjApXQogICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFVJbnQxNjAgZGVwbG95ZXIgPSBkZWZhdWx0OwoKICAgICAgICAvLyBQcmVmaXhfVG90YWxTdXBwbHkgPSAweDAwOyBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CiAgICAgICAgcHJpdmF0ZSBjb25zdCBieXRlIFByZWZpeF9Db250cmFjdCA9IDB4MDI7CiAgICAgICAgcHVibGljIHN0YXRpYyByZWFkb25seSBTdG9yYWdlTWFwIENvbnRyYWN0TWFwID0gbmV3IFN0b3JhZ2VNYXAoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0NvbnRyYWN0KTsKICAgICAgICBwcml2YXRlIHN0YXRpYyBpbnQgSW5pdGlhbENvaW5zID0+IHt7Q29udHJhY3RJbml0aWFsQ29pbnN9fTsKCiAgICAgICAgW0Rpc3BsYXlOYW1lKCJOYW1lIildCiAgICAgICAgcHVibGljIG92ZXJyaWRlIHN0cmluZyBUb2tlbk5hbWUoKSA9PiAie3tDb250cmFjdE5hbWV9fSI7CiAgICAgICAgcHVibGljIG92ZXJyaWRlIHN0cmluZyBTeW1ib2woKSA9PiAie3tDb250cmFjdFN5bWJvbH19IjsKICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgYnl0ZSBEZWNpbWFscygpID0+IHt7Q29udHJhY3REZWNpbWFsc319OwoKICAgICAgICBwdWJsaWMgc3RhdGljIHZvaWQgX2RlcGxveShvYmplY3QgZGF0YSwgYm9vbCB1cGRhdGUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodXBkYXRlKSByZXR1cm47CiAgICAgICAgICAgIE1pbnQob3duZXIsIEluaXRpYWxDb2lucyk7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIG5ldyB2b2lkIE1pbnQoVUludDE2MCBhY2NvdW50LCBCaWdJbnRlZ2VyIGFtb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghSXNPd25lcigpKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigkIk1pbnQ6IE5vIEF1dGhvcml6YXRpb24iKTsKICAgICAgICAgICAgTWludEltcGwoYWNjb3VudCwgYW1vdW50KTsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgbmV3IHZvaWQgQnVybihVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiQnVybjogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBCdXJuSW1wbChhY2NvdW50LCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIHN0YXRpYyBib29sIFVwZGF0ZShCeXRlU3RyaW5nIG5lZkZpbGUsIHN0cmluZyBtYW5pZmVzdCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICghSXNPd25lcigpKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigkIlVwZGF0ZTogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBDb250cmFjdE1hbmFnZW1lbnQuVXBkYXRlKG5lZkZpbGUsIG1hbmlmZXN0LCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgRGVzdHJveSgpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUlzT3duZXIoKSkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oJCJEZXN0cm95OiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIENvbnRyYWN0TWFuYWdlbWVudC5EZXN0cm95KCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgYm9vbCBJc093bmVyKCkgewogICAgICAgICAgICByZXR1cm4gUnVudGltZS5DaGVja1dpdG5lc3Mob3duZXIpIHx8IFJ1bnRpbWUuQ2hlY2tXaXRuZXNzKGRlcGxveWVyKTsKICAgICAgICB9CiAgICB9Cn0K';

    constructor(
        private readonly caasClient: CaasClient
    ) {
    }

    async compileSource(source: string): Promise<CaasResult> {
        try {
            const task = new CaasTask(source);
            this.logger.debug(`Compiling ${task.contractSource}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }

    async compileTokenNep17(dto: CreateSmartContractNep17Dto): Promise<CaasResult> {
        try {
            const source = SmartContractCompilerService.nep17Template;
            const task = new CaasTask(source, [], {
                contractSource: source,
                contractCompileOptions: [''],
                systemOwnerAddress: dto.ownerAddress,
                contractAuthorAddress: dto.ownerAddress,
                contractAuthorName: 'Team11',
                contractAuthorEmail: 'info@dvita.com',
                contractName: dto.name,
                contractSymbol: dto.symbol,
                contractDescription: dto.description,
                contractFactor: '0',
                contractDecimals: dto.decimals.toString(),
                contractInitialCoins: dto.initial.toString()
            });
            this.logger.debug(`Compiling ${JSON.stringify(task).substring(0, 64)}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                this.logger.error(createResult.error);
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }

    async compileNftNep11(dto: CreateSmartContractNep11Dto): Promise<CaasResult> {
        try {
            const source = SmartContractCompilerService.nep11Template;
            const task = new CaasTask(source, [], {
                contractSource: source,
                contractCompileOptions: [''],
                systemOwnerAddress: dto.ownerAddress,
                contractAuthorAddress: dto.ownerAddress,
                contractAuthorName: 'Team11',
                contractAuthorEmail: 'info@dvita.com',
                contractName: dto.name,
                contractSymbol: dto.symbol,
                contractDescription: dto.description,
                contractFactor: '0',
                contractDecimals: '0',
                contractInitialCoins: '0'
            });
            this.logger.debug(`Compiling ${JSON.stringify(task).substring(0, 64)}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }
}