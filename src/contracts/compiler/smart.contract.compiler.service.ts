import { BadRequestException, Injectable, Logger } from "@nestjs/common";
import { CreateSmartContractNep11Dto } from "../dto/create.smart.contract.nep11.dto";
import { CreateSmartContractNep17Dto } from "../dto/create.smart.contract.nep17.dto";
import { CaasClient } from "./caas.client";
import { CaasTask } from "./types/caas.task";
import { CaasResult } from "./types/caas.task.result";

@Injectable()
export class SmartContractCompilerService {
    private readonly logger = new Logger(SmartContractCompilerService.name);

    private static readonly nep17Template = 'dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uTnVtZXJpY3M7CnVzaW5nIFN5c3RlbS5Db21wb25lbnRNb2RlbDsKdXNpbmcgU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlczsKdXNpbmcgTmVvLlNtYXJ0Q29udHJhY3QuRnJhbWV3b3JrOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuTmF0aXZlOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuU2VydmljZXM7CgpuYW1lc3BhY2UgTmVvLlNtYXJ0Q29udHJhY3QuRXhhbXBsZXMKewogICAgcHVibGljIGFic3RyYWN0IGNsYXNzIE5YQVRva2VuQ29udHJhY3QgOiBTbWFydENvbnRyYWN0LkZyYW1ld29yay5TbWFydENvbnRyYWN0CiAgICB7CiAgICAgICAgcHJvdGVjdGVkIGNvbnN0IGJ5dGUgUHJlZml4X1RvdGFsU3VwcGx5ID0gMHgwMDsKICAgICAgICBwcm90ZWN0ZWQgY29uc3QgYnl0ZSBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CgogICAgICAgIFtTYWZlXQogICAgICAgIFtEaXNwbGF5TmFtZSgiTmFtZSIpXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgVG9rZW5OYW1lKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgU3ltYm9sKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBieXRlIERlY2ltYWxzKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBUb3RhbFN1cHBseSgpID0+IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KFN0b3JhZ2UuQ3VycmVudENvbnRleHQsIG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfSk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBCYWxhbmNlT2YoVUludDE2MCBvd25lcikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvd25lciBpcyBudWxsIHx8ICFvd25lci5Jc1ZhbGlkKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiQmFsYW5jZU9mOiBUaGUgYXJndW1lbnQgJ293bmVyJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBTdG9yYWdlTWFwIGJhbGFuY2VNYXAgPSBuZXcoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0JhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gKEJpZ0ludGVnZXIpYmFsYW5jZU1hcFtvd25lcl07CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIHZvaWQgVXBkYXRlVG90YWxTdXBwbHkoQmlnSW50ZWdlciBpbmNyZW1lbnQpCiAgICAgICAgewogICAgICAgICAgICBTdG9yYWdlQ29udGV4dCBjb250ZXh0ID0gU3RvcmFnZS5DdXJyZW50Q29udGV4dDsKICAgICAgICAgICAgYnl0ZVtdIGtleSA9IG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfTsKICAgICAgICAgICAgQmlnSW50ZWdlciB0b3RhbFN1cHBseSA9IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KGNvbnRleHQsIGtleSk7CiAgICAgICAgICAgIHRvdGFsU3VwcGx5ICs9IGluY3JlbWVudDsKICAgICAgICAgICAgU3RvcmFnZS5QdXQoY29udGV4dCwga2V5LCB0b3RhbFN1cHBseSk7CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIGJvb2wgVXBkYXRlQmFsYW5jZShVSW50MTYwIG93bmVyLCBCaWdJbnRlZ2VyIGluY3JlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIFN0b3JhZ2VNYXAgYmFsYW5jZU1hcCA9IG5ldyhTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQmFsYW5jZSk7CiAgICAgICAgICAgIEJpZ0ludGVnZXIgYmFsYW5jZSA9IChCaWdJbnRlZ2VyKWJhbGFuY2VNYXBbb3duZXJdOwogICAgICAgICAgICBiYWxhbmNlICs9IGluY3JlbWVudDsKICAgICAgICAgICAgaWYgKGJhbGFuY2UgPCAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChiYWxhbmNlLklzWmVybykKICAgICAgICAgICAgICAgIGJhbGFuY2VNYXAuRGVsZXRlKG93bmVyKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgYmFsYW5jZU1hcC5QdXQob3duZXIsIGJhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgYWJzdHJhY3QgY2xhc3MgTlhBTmVwMTdUb2tlbiA6IE5YQVRva2VuQ29udHJhY3QKICAgIHsKICAgICAgICBwdWJsaWMgZGVsZWdhdGUgdm9pZCBPblRyYW5zZmVyRGVsZWdhdGUoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCk7CgogICAgICAgIFtEaXNwbGF5TmFtZSgiVHJhbnNmZXIiKV0KICAgICAgICBwdWJsaWMgc3RhdGljIGV2ZW50IE9uVHJhbnNmZXJEZWxlZ2F0ZSBPblRyYW5zZmVyOwoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgVHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZnJvbSBpcyBudWxsIHx8ICFmcm9tLklzVmFsaWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUcmFuc2ZlcjogVGhlIGFyZ3VtZW50ICdmcm9tJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAodG8gaXMgbnVsbCB8fCAhdG8uSXNWYWxpZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYXJndW1lbnQgJ3RvJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAoYW1vdW50IDwgMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYW1vdW50IG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXIuIik7CiAgICAgICAgICAgIC8vaWYgKCFSdW50aW1lLkNoZWNrV2l0bmVzcyhmcm9tKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoYW1vdW50ICE9IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghVXBkYXRlQmFsYW5jZShmcm9tLCAtYW1vdW50KSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBVcGRhdGVCYWxhbmNlKHRvLCArYW1vdW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBQb3N0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCwgZGF0YSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIE1pbnRJbXBsKFVJbnQxNjAgYWNjb3VudCwgQmlnSW50ZWdlciBhbW91bnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoYW1vdW50LlNpZ24gPCAwKSB0aHJvdyBuZXcgQXJndW1lbnRPdXRPZlJhbmdlRXhjZXB0aW9uKG5hbWVvZihhbW91bnQpKTsKICAgICAgICAgICAgaWYgKGFtb3VudC5Jc1plcm8pIHJldHVybjsKICAgICAgICAgICAgVXBkYXRlQmFsYW5jZShhY2NvdW50LCArYW1vdW50KTsKICAgICAgICAgICAgVXBkYXRlVG90YWxTdXBwbHkoK2Ftb3VudCk7CiAgICAgICAgICAgIFBvc3RUcmFuc2ZlcihudWxsLCBhY2NvdW50LCBhbW91bnQsIG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIEJ1cm5JbXBsKFVJbnQxNjAgYWNjb3VudCwgQmlnSW50ZWdlciBhbW91bnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoYW1vdW50LlNpZ24gPCAwKSB0aHJvdyBuZXcgQXJndW1lbnRPdXRPZlJhbmdlRXhjZXB0aW9uKG5hbWVvZihhbW91bnQpKTsKICAgICAgICAgICAgaWYgKGFtb3VudC5Jc1plcm8pIHJldHVybjsKICAgICAgICAgICAgaWYgKCFVcGRhdGVCYWxhbmNlKGFjY291bnQsIC1hbW91bnQpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oKTsKICAgICAgICAgICAgVXBkYXRlVG90YWxTdXBwbHkoLWFtb3VudCk7CiAgICAgICAgICAgIFBvc3RUcmFuc2ZlcihhY2NvdW50LCBudWxsLCBhbW91bnQsIG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIFBvc3RUcmFuc2ZlcihVSW50MTYwIGZyb20sIFVJbnQxNjAgdG8sIEJpZ0ludGVnZXIgYW1vdW50LCBvYmplY3QgZGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIE9uVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCk7CiAgICAgICAgICAgIGlmICh0byBpcyBub3QgbnVsbCAmJiBDb250cmFjdE1hbmFnZW1lbnQuR2V0Q29udHJhY3QodG8pIGlzIG5vdCBudWxsKQogICAgICAgICAgICAgICAgQ29udHJhY3QuQ2FsbCh0bywgIm9uTkVQMTdQYXltZW50IiwgQ2FsbEZsYWdzLkFsbCwgZnJvbSwgYW1vdW50LCBkYXRhKTsKICAgICAgICB9CiAgICB9CgogICAgW01hbmlmZXN0RXh0cmEoIkF1dGhvciIsICJ7e0NvbnRyYWN0QXV0aG9yTmFtZX19IildCiAgICBbTWFuaWZlc3RFeHRyYSgiRW1haWwiLCAie3tDb250cmFjdEF1dGhvckVtYWlsfX0iKV0KICAgIFtNYW5pZmVzdEV4dHJhKCJEZXNjcmlwdGlvbiIsICJ7e0NvbnRyYWN0RGVzY3JpcHRpb259fSIpXQogICAgW01hbmlmZXN0RXh0cmEoIlZlcnNpb24iLCAiMS4wIildCiAgICBbU3VwcG9ydGVkU3RhbmRhcmRzKCJORVAtMTciKV0KICAgIFtDb250cmFjdFBlcm1pc3Npb24oIioiLCAib25ORVAxN1BheW1lbnQiKV0KICAgIHB1YmxpYyBwYXJ0aWFsIGNsYXNzIHt7Q29udHJhY3ROYW1lfX1Ub2tlbiA6IE5YQU5lcDE3VG9rZW4KICAgIHsKICAgICAgICBbSW5pdGlhbFZhbHVlKCJ7e0NvbnRyYWN0QXV0aG9yQWRkcmVzc319IiwgQ29udHJhY3RQYXJhbWV0ZXJUeXBlLkhhc2gxNjApXQogICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFVJbnQxNjAgb3duZXIgPSBkZWZhdWx0OwogICAgICAgIFtJbml0aWFsVmFsdWUoInt7U3lzdGVtT3duZXJBZGRyZXNzfX0iLCBDb250cmFjdFBhcmFtZXRlclR5cGUuSGFzaDE2MCldCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVUludDE2MCBkZXBsb3llciA9IGRlZmF1bHQ7CgogICAgICAgIC8vIFByZWZpeF9Ub3RhbFN1cHBseSA9IDB4MDA7IFByZWZpeF9CYWxhbmNlID0gMHgwMTsKICAgICAgICBwcml2YXRlIGNvbnN0IGJ5dGUgUHJlZml4X0NvbnRyYWN0ID0gMHgwMjsKICAgICAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFN0b3JhZ2VNYXAgQ29udHJhY3RNYXAgPSBuZXcgU3RvcmFnZU1hcChTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQ29udHJhY3QpOwogICAgICAgIHByaXZhdGUgc3RhdGljIGludCBJbml0aWFsQ29pbnMgPT4ge3tDb250cmFjdEluaXRpYWxDb2luc319OwoKICAgICAgICBbRGlzcGxheU5hbWUoIk5hbWUiKV0KICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgc3RyaW5nIFRva2VuTmFtZSgpID0+ICJ7e0NvbnRyYWN0TmFtZX19IjsKICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgc3RyaW5nIFN5bWJvbCgpID0+ICJ7e0NvbnRyYWN0U3ltYm9sfX0iOwogICAgICAgIHB1YmxpYyBvdmVycmlkZSBieXRlIERlY2ltYWxzKCkgPT4ge3tDb250cmFjdERlY2ltYWxzfX07CgogICAgICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBfZGVwbG95KG9iamVjdCBkYXRhLCBib29sIHVwZGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1cGRhdGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKEluaXRpYWxDb2lucyA+IDApIHsKICAgICAgICAgICAgICAgIE1pbnQob3duZXIsIEluaXRpYWxDb2lucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgbmV3IHZvaWQgTWludChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgLy9pZiAoIUlzT3duZXIoKSkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oJCJNaW50OiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIE1pbnRJbXBsKGFjY291bnQsIGFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIG5ldyB2b2lkIEJ1cm4oVUludDE2MCBhY2NvdW50LCBCaWdJbnRlZ2VyIGFtb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiQnVybjogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBCdXJuSW1wbChhY2NvdW50LCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIHN0YXRpYyBib29sIFVwZGF0ZShCeXRlU3RyaW5nIG5lZkZpbGUsIHN0cmluZyBtYW5pZmVzdCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiVXBkYXRlOiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIENvbnRyYWN0TWFuYWdlbWVudC5VcGRhdGUobmVmRmlsZSwgbWFuaWZlc3QsIG51bGwpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgYm9vbCBEZXN0cm95KCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiRGVzdHJveTogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBDb250cmFjdE1hbmFnZW1lbnQuRGVzdHJveSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHByaXZhdGUgc3RhdGljIGJvb2wgSXNPd25lcigpIHsKICAgICAgICAgICAgcmV0dXJuIFJ1bnRpbWUuQ2hlY2tXaXRuZXNzKG93bmVyKSB8fCBSdW50aW1lLkNoZWNrV2l0bmVzcyhkZXBsb3llcik7CiAgICAgICAgfQogICAgfQp9Cg==';
    private static readonly nep11Template = 'dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uTnVtZXJpY3M7CnVzaW5nIFN5c3RlbS5Db21wb25lbnRNb2RlbDsKdXNpbmcgU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlczsKdXNpbmcgTmVvLlNtYXJ0Q29udHJhY3QuRnJhbWV3b3JrOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuTmF0aXZlOwp1c2luZyBOZW8uU21hcnRDb250cmFjdC5GcmFtZXdvcmsuU2VydmljZXM7CgpuYW1lc3BhY2UgTmVvLlNtYXJ0Q29udHJhY3QuRXhhbXBsZXMKewogICAgcHVibGljIGFic3RyYWN0IGNsYXNzIE5YQVRva2VuQ29udHJhY3QgOiBTbWFydENvbnRyYWN0LkZyYW1ld29yay5TbWFydENvbnRyYWN0CiAgICB7CiAgICAgICAgcHJvdGVjdGVkIGNvbnN0IGJ5dGUgUHJlZml4X1RvdGFsU3VwcGx5ID0gMHgwMDsKICAgICAgICBwcm90ZWN0ZWQgY29uc3QgYnl0ZSBQcmVmaXhfQmFsYW5jZSA9IDB4MDE7CgogICAgICAgIFtTYWZlXQogICAgICAgIFtEaXNwbGF5TmFtZSgiTmFtZSIpXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgVG9rZW5OYW1lKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBzdHJpbmcgU3ltYm9sKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBhYnN0cmFjdCBieXRlIERlY2ltYWxzKCk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBUb3RhbFN1cHBseSgpID0+IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KFN0b3JhZ2UuQ3VycmVudENvbnRleHQsIG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfSk7CgogICAgICAgIFtTYWZlXQogICAgICAgIHB1YmxpYyBzdGF0aWMgQmlnSW50ZWdlciBCYWxhbmNlT2YoVUludDE2MCBvd25lcikKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvd25lciBpcyBudWxsIHx8ICFvd25lci5Jc1ZhbGlkKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV4Y2VwdGlvbigiQmFsYW5jZU9mOiBUaGUgYXJndW1lbnQgJ293bmVyJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBTdG9yYWdlTWFwIGJhbGFuY2VNYXAgPSBuZXcoU3RvcmFnZS5DdXJyZW50Q29udGV4dCwgUHJlZml4X0JhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gKEJpZ0ludGVnZXIpYmFsYW5jZU1hcFtvd25lcl07CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIHZvaWQgVXBkYXRlVG90YWxTdXBwbHkoQmlnSW50ZWdlciBpbmNyZW1lbnQpCiAgICAgICAgewogICAgICAgICAgICBTdG9yYWdlQ29udGV4dCBjb250ZXh0ID0gU3RvcmFnZS5DdXJyZW50Q29udGV4dDsKICAgICAgICAgICAgYnl0ZVtdIGtleSA9IG5ldyBieXRlW10geyBQcmVmaXhfVG90YWxTdXBwbHkgfTsKICAgICAgICAgICAgQmlnSW50ZWdlciB0b3RhbFN1cHBseSA9IChCaWdJbnRlZ2VyKVN0b3JhZ2UuR2V0KGNvbnRleHQsIGtleSk7CiAgICAgICAgICAgIHRvdGFsU3VwcGx5ICs9IGluY3JlbWVudDsKICAgICAgICAgICAgU3RvcmFnZS5QdXQoY29udGV4dCwga2V5LCB0b3RhbFN1cHBseSk7CiAgICAgICAgfQoKICAgICAgICBwcm90ZWN0ZWQgc3RhdGljIGJvb2wgVXBkYXRlQmFsYW5jZShVSW50MTYwIG93bmVyLCBCaWdJbnRlZ2VyIGluY3JlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIFN0b3JhZ2VNYXAgYmFsYW5jZU1hcCA9IG5ldyhTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQmFsYW5jZSk7CiAgICAgICAgICAgIEJpZ0ludGVnZXIgYmFsYW5jZSA9IChCaWdJbnRlZ2VyKWJhbGFuY2VNYXBbb3duZXJdOwogICAgICAgICAgICBiYWxhbmNlICs9IGluY3JlbWVudDsKICAgICAgICAgICAgaWYgKGJhbGFuY2UgPCAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChiYWxhbmNlLklzWmVybykKICAgICAgICAgICAgICAgIGJhbGFuY2VNYXAuRGVsZXRlKG93bmVyKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgYmFsYW5jZU1hcC5QdXQob3duZXIsIGJhbGFuY2UpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CgogICAgW1N1cHBvcnRlZFN0YW5kYXJkcygiTkVQLTE3IildCiAgICBbQ29udHJhY3RQZXJtaXNzaW9uKCIqIiwgIm9uTkVQMTdQYXltZW50IildCiAgICBwdWJsaWMgYWJzdHJhY3QgY2xhc3MgTlhBTmVwMTdUb2tlbiA6IE5YQVRva2VuQ29udHJhY3QKICAgIHsKICAgICAgICBwdWJsaWMgZGVsZWdhdGUgdm9pZCBPblRyYW5zZmVyRGVsZWdhdGUoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCk7CgogICAgICAgIFtEaXNwbGF5TmFtZSgiVHJhbnNmZXIiKV0KICAgICAgICBwdWJsaWMgc3RhdGljIGV2ZW50IE9uVHJhbnNmZXJEZWxlZ2F0ZSBPblRyYW5zZmVyOwoKICAgICAgICBwdWJsaWMgc3RhdGljIGJvb2wgVHJhbnNmZXIoVUludDE2MCBmcm9tLCBVSW50MTYwIHRvLCBCaWdJbnRlZ2VyIGFtb3VudCwgb2JqZWN0IGRhdGEpCiAgICAgICAgewogICAgICAgICAgICBpZiAoZnJvbSBpcyBudWxsIHx8ICFmcm9tLklzVmFsaWQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKCJUcmFuc2ZlcjogVGhlIGFyZ3VtZW50ICdmcm9tJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAodG8gaXMgbnVsbCB8fCAhdG8uSXNWYWxpZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYXJndW1lbnQgJ3RvJyBpcyBpbnZhbGlkLiIpOwogICAgICAgICAgICBpZiAoYW1vdW50IDwgMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeGNlcHRpb24oIlRyYW5zZmVyOiBUaGUgYW1vdW50IG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXIuIik7CiAgICAgICAgICAgIC8vaWYgKCFSdW50aW1lLkNoZWNrV2l0bmVzcyhmcm9tKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoYW1vdW50ICE9IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghVXBkYXRlQmFsYW5jZShmcm9tLCAtYW1vdW50KSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICBVcGRhdGVCYWxhbmNlKHRvLCArYW1vdW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBQb3N0VHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCwgZGF0YSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIE1pbnRJbXBsKFVJbnQxNjAgYWNjb3VudCwgQmlnSW50ZWdlciBhbW91bnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoYW1vdW50LlNpZ24gPCAwKSB0aHJvdyBuZXcgQXJndW1lbnRPdXRPZlJhbmdlRXhjZXB0aW9uKG5hbWVvZihhbW91bnQpKTsKICAgICAgICAgICAgaWYgKGFtb3VudC5Jc1plcm8pIHJldHVybjsKICAgICAgICAgICAgVXBkYXRlQmFsYW5jZShhY2NvdW50LCArYW1vdW50KTsKICAgICAgICAgICAgVXBkYXRlVG90YWxTdXBwbHkoK2Ftb3VudCk7CiAgICAgICAgICAgIFBvc3RUcmFuc2ZlcihudWxsLCBhY2NvdW50LCBhbW91bnQsIG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIEJ1cm5JbXBsKFVJbnQxNjAgYWNjb3VudCwgQmlnSW50ZWdlciBhbW91bnQpCiAgICAgICAgewogICAgICAgICAgICBpZiAoYW1vdW50LlNpZ24gPCAwKSB0aHJvdyBuZXcgQXJndW1lbnRPdXRPZlJhbmdlRXhjZXB0aW9uKG5hbWVvZihhbW91bnQpKTsKICAgICAgICAgICAgaWYgKGFtb3VudC5Jc1plcm8pIHJldHVybjsKICAgICAgICAgICAgaWYgKCFVcGRhdGVCYWxhbmNlKGFjY291bnQsIC1hbW91bnQpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oKTsKICAgICAgICAgICAgVXBkYXRlVG90YWxTdXBwbHkoLWFtb3VudCk7CiAgICAgICAgICAgIFBvc3RUcmFuc2ZlcihhY2NvdW50LCBudWxsLCBhbW91bnQsIG51bGwpOwogICAgICAgIH0KCiAgICAgICAgcHJvdGVjdGVkIHN0YXRpYyB2b2lkIFBvc3RUcmFuc2ZlcihVSW50MTYwIGZyb20sIFVJbnQxNjAgdG8sIEJpZ0ludGVnZXIgYW1vdW50LCBvYmplY3QgZGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIE9uVHJhbnNmZXIoZnJvbSwgdG8sIGFtb3VudCk7CiAgICAgICAgICAgIGlmICh0byBpcyBub3QgbnVsbCAmJiBDb250cmFjdE1hbmFnZW1lbnQuR2V0Q29udHJhY3QodG8pIGlzIG5vdCBudWxsKQogICAgICAgICAgICAgICAgQ29udHJhY3QuQ2FsbCh0bywgIm9uTkVQMTdQYXltZW50IiwgQ2FsbEZsYWdzLkFsbCwgZnJvbSwgYW1vdW50LCBkYXRhKTsKICAgICAgICB9CiAgICB9CgogICAgW01hbmlmZXN0RXh0cmEoIkF1dGhvciIsICJ7e0NvbnRyYWN0QXV0aG9yTmFtZX19IildCiAgICBbTWFuaWZlc3RFeHRyYSgiRW1haWwiLCAie3tDb250cmFjdEF1dGhvckVtYWlsfX0iKV0KICAgIFtNYW5pZmVzdEV4dHJhKCJEZXNjcmlwdGlvbiIsICJ7e0NvbnRyYWN0RGVzY3JpcHRpb259fSIpXQogICAgW01hbmlmZXN0RXh0cmEoIlZlcnNpb24iLCAiMS4wIildCiAgICBbU3VwcG9ydGVkU3RhbmRhcmRzKCJORVAtMTciKV0KICAgIFtDb250cmFjdFBlcm1pc3Npb24oIioiLCAib25ORVAxN1BheW1lbnQiKV0KICAgIHB1YmxpYyBwYXJ0aWFsIGNsYXNzIHt7Q29udHJhY3ROYW1lfX1Ub2tlbiA6IE5YQU5lcDE3VG9rZW4KICAgIHsKICAgICAgICBbSW5pdGlhbFZhbHVlKCJ7e0NvbnRyYWN0QXV0aG9yQWRkcmVzc319IiwgQ29udHJhY3RQYXJhbWV0ZXJUeXBlLkhhc2gxNjApXQogICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFVJbnQxNjAgb3duZXIgPSBkZWZhdWx0OwogICAgICAgIFtJbml0aWFsVmFsdWUoInt7U3lzdGVtT3duZXJBZGRyZXNzfX0iLCBDb250cmFjdFBhcmFtZXRlclR5cGUuSGFzaDE2MCldCiAgICAgICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVUludDE2MCBkZXBsb3llciA9IGRlZmF1bHQ7CgogICAgICAgIC8vIFByZWZpeF9Ub3RhbFN1cHBseSA9IDB4MDA7IFByZWZpeF9CYWxhbmNlID0gMHgwMTsKICAgICAgICBwcml2YXRlIGNvbnN0IGJ5dGUgUHJlZml4X0NvbnRyYWN0ID0gMHgwMjsKICAgICAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFN0b3JhZ2VNYXAgQ29udHJhY3RNYXAgPSBuZXcgU3RvcmFnZU1hcChTdG9yYWdlLkN1cnJlbnRDb250ZXh0LCBQcmVmaXhfQ29udHJhY3QpOwogICAgICAgIHByaXZhdGUgc3RhdGljIGludCBJbml0aWFsQ29pbnMgPT4ge3tDb250cmFjdEluaXRpYWxDb2luc319OwoKICAgICAgICBbRGlzcGxheU5hbWUoIk5hbWUiKV0KICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgc3RyaW5nIFRva2VuTmFtZSgpID0+ICJ7e0NvbnRyYWN0TmFtZX19IjsKICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgc3RyaW5nIFN5bWJvbCgpID0+ICJ7e0NvbnRyYWN0U3ltYm9sfX0iOwogICAgICAgIHB1YmxpYyBvdmVycmlkZSBieXRlIERlY2ltYWxzKCkgPT4ge3tDb250cmFjdERlY2ltYWxzfX07CgogICAgICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBfZGVwbG95KG9iamVjdCBkYXRhLCBib29sIHVwZGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh1cGRhdGUpIHJldHVybjsKICAgICAgICAgICAgaWYgKEluaXRpYWxDb2lucyA+IDApIHsKICAgICAgICAgICAgICAgIE1pbnQob3duZXIsIEluaXRpYWxDb2lucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgbmV3IHZvaWQgTWludChVSW50MTYwIGFjY291bnQsIEJpZ0ludGVnZXIgYW1vdW50KQogICAgICAgIHsKICAgICAgICAgICAgLy9pZiAoIUlzT3duZXIoKSkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oJCJNaW50OiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIE1pbnRJbXBsKGFjY291bnQsIGFtb3VudCk7CiAgICAgICAgfQoKICAgICAgICBwdWJsaWMgc3RhdGljIG5ldyB2b2lkIEJ1cm4oVUludDE2MCBhY2NvdW50LCBCaWdJbnRlZ2VyIGFtb3VudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiQnVybjogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBCdXJuSW1wbChhY2NvdW50LCBhbW91bnQpOwogICAgICAgIH0KCiAgICAgICAgcHVibGljIHN0YXRpYyBib29sIFVwZGF0ZShCeXRlU3RyaW5nIG5lZkZpbGUsIHN0cmluZyBtYW5pZmVzdCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiVXBkYXRlOiBObyBBdXRob3JpemF0aW9uIik7CiAgICAgICAgICAgIENvbnRyYWN0TWFuYWdlbWVudC5VcGRhdGUobmVmRmlsZSwgbWFuaWZlc3QsIG51bGwpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHB1YmxpYyBzdGF0aWMgYm9vbCBEZXN0cm95KCkKICAgICAgICB7CiAgICAgICAgICAgIC8vaWYgKCFJc093bmVyKCkpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCQiRGVzdHJveTogTm8gQXV0aG9yaXphdGlvbiIpOwogICAgICAgICAgICBDb250cmFjdE1hbmFnZW1lbnQuRGVzdHJveSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHByaXZhdGUgc3RhdGljIGJvb2wgSXNPd25lcigpIHsKICAgICAgICAgICAgcmV0dXJuIFJ1bnRpbWUuQ2hlY2tXaXRuZXNzKG93bmVyKSB8fCBSdW50aW1lLkNoZWNrV2l0bmVzcyhkZXBsb3llcik7CiAgICAgICAgfQogICAgfQp9Cg==';

    constructor(
        private readonly caasClient: CaasClient
    ) {
    }

    async compileSource(source: string): Promise<CaasResult> {
        try {
            const task = new CaasTask(source);
            this.logger.debug(`Compiling ${task.contractSource}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }

    async compileTokenNep17(dto: CreateSmartContractNep17Dto): Promise<CaasResult> {
        try {
            const source = SmartContractCompilerService.nep17Template;
            const task = new CaasTask(source, [], {
                contractSource: source,
                contractCompileOptions: [''],
                systemOwnerAddress: dto.ownerAddress,
                contractAuthorAddress: dto.ownerAddress,
                contractAuthorName: 'Team11',
                contractAuthorEmail: 'info@dvita.com',
                contractName: dto.name,
                contractSymbol: dto.symbol,
                contractDescription: dto.description,
                contractFactor: '0',
                contractDecimals: dto.decimals.toString(),
                contractInitialCoins: dto.initial.toString()
            });
            this.logger.debug(`Compiling ${JSON.stringify(task).substring(0, 64)}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                this.logger.error(createResult.error);
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }

    async compileNftNep11(dto: CreateSmartContractNep11Dto): Promise<CaasResult> {
        try {
            const source = SmartContractCompilerService.nep11Template;
            const task = new CaasTask(source, [], {
                contractSource: source,
                contractCompileOptions: [''],
                systemOwnerAddress: dto.ownerAddress,
                contractAuthorAddress: dto.ownerAddress,
                contractAuthorName: 'Team11',
                contractAuthorEmail: 'info@dvita.com',
                contractName: dto.name,
                contractSymbol: dto.symbol,
                contractDescription: dto.description,
                contractFactor: '0',
                contractDecimals: '0',
                contractInitialCoins: '0'
            });
            this.logger.debug(`Compiling ${JSON.stringify(task).substring(0, 64)}...`);
            const createResult = await this.caasClient.createCompilerTask(task);
            this.logger.debug(JSON.stringify(createResult));
            if (createResult.error) {
                throw new BadRequestException(createResult.error, 'Compilation error');
            }
            return createResult.result;
        } catch(e) {
            this.logger.error(`${e}, ${e.stack}`);
            throw e;
        }
    }
}

/*
  PSPFive PSP5 0x2478be91899b13bc02b6adf01c060aacb7ace50a
  scriptHash: '0x2478be91899b13bc02b6adf01c060aacb7ace50a',
  address: 'NLub5kVLQoMQTw8SgrB2syWWNySMy7g7wN',
  sent: '0xb1569a58e6a00cee281796d8a868d6373a8978d78cd87865a9379fd91385d747'

  Block Hash 0x14eb80e11b8fdbe2f2fa57b38d40f4166ef1029046a9ed721fe07fd21447bced
  TX Hash 0xb1569a58e6a00cee281796d8a868d6373a8978d78cd87865a9379fd91385d747
*/